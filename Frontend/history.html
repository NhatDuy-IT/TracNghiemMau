<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử thi - Thi Trắc Nghiệm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .score-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="home.html">Thi Trắc Nghiệm</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="home.html">Trang chủ</a>
                <span class="nav-link" id="userName"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Đăng xuất</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">Lịch sử các lần thi</h2>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="historyTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Môn thi</th>
                            <th>Điểm</th>
                            <th>Số câu đúng</th>
                            <th>Tổng số câu</th>
                            <th>Ngày thi</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role === 'Admin') {
            window.location.href = 'index.html';
        }

        document.getElementById('userName').textContent = user.fullName || user.username;

        // Load exam history
        async function loadHistory() {
            try {
                const response = await userAPI.getExamHistory();
                const history = await response.json();

                const tbody = document.getElementById('historyBody');

                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Bạn chưa thi lần nào!</td></tr>';
                    return;
                }

                tbody.innerHTML = history.map((item, index) => {
                    const date = new Date(item.ExamDate).toLocaleString('vi-VN');
                    const scoreClass = item.Score >= 5 ? 'bg-success' : 'bg-danger';
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.SubjectName}</td>
                    <td><span class="badge ${scoreClass} score-badge">${item.Score}</span></td>
                            <td>${item.CorrectAnswers}</td>
                            <td>${item.TotalQuestions}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('Lỗi tải lịch sử thi');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        loadHistory();
    </script>
</body>
</html>
