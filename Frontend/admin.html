<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ExamMaster - Quản trị</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 antialiased">
    <!-- Navigation -->
    <header class="sticky top-0 z-50 w-full bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-8">
                    <a class="flex items-center gap-2 text-primary" href="admin.html">
                        <span class="material-symbols-outlined text-3xl font-bold">analytics</span>
                        <span class="text-slate-900 dark:text-white text-xl font-extrabold tracking-tight">ExamMaster</span>
                        <span class="ml-2 px-2 py-0.5 bg-primary text-white text-xs rounded-full">Admin</span>
                    </a>
                    <nav class="hidden md:flex items-center gap-6">
                        <a class="text-sm font-medium text-primary" href="admin.html">Quản lý</a>
                        <a class="text-sm font-medium text-slate-600 hover:text-primary dark:text-slate-300" href="history.html">Lịch sử thi</a>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300" id="userName"></span>
                    <button class="text-sm font-bold text-slate-700 dark:text-slate-200 hover:text-primary px-4 py-2 transition-colors" onclick="logout()">Đăng xuất</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="flex gap-4 mb-8 border-b border-slate-200 dark:border-slate-700">
            <button class="px-4 py-2 text-sm font-semibold text-primary border-b-2 border-primary" id="tabSubjects" onclick="showTab('subjects')">Quản lý Môn thi</button>
            <button class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700" id="tabQuestions" onclick="showTab('questions')">Quản lý Câu hỏi</button>
            <button class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700" id="tabHistory" onclick="showTab('history')">Lịch sử thi</button>
        </div>

        <!-- Subjects Tab -->
        <div id="subjectsTab">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Quản lý Môn thi</h2>
                <button class="bg-primary hover:bg-primary/90 text-white font-bold px-6 py-2.5 rounded-lg transition-all flex items-center gap-2" onclick="showSubjectModal()">
                    <span class="material-symbols-outlined">add</span>
                    Thêm môn thi
                </button>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-slate-50 dark:bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Tên môn thi</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Mô tả</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="subjectTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Questions Tab -->
        <div id="questionsTab" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Quản lý Câu hỏi</h2>
                <button class="bg-primary hover:bg-primary/90 text-white font-bold px-6 py-2.5 rounded-lg transition-all flex items-center gap-2" onclick="showQuestionModal()">
                    <span class="material-symbols-outlined">add</span>
                    Thêm câu hỏi
                </button>
            </div>
            <div class="mb-4">
                <label for="filterSubject" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Lọc theo môn thi</label>
                <select id="filterSubject" title="Lọc câu hỏi theo môn thi" class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" onchange="loadQuestions()">
                    <option value="">Tất cả môn thi</option>
                </select>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-slate-50 dark:bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Câu hỏi</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Môn thi</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Đáp án đúng</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="questionTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="hidden">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Lịch sử thi toàn hệ thống</h2>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-slate-50 dark:bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Người dùng</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Môn thi</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Điểm</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Ngày thi</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Subject Modal -->
    <div id="subjectModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4" id="subjectModalTitle">Thêm môn thi</h3>
            <form id="subjectForm" onsubmit="saveSubject(event)">
                <input type="hidden" id="subjectId"/>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Tên môn thi</label>
                    <input type="text" id="subjectName" placeholder="Nhập tên môn thi" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required/>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Mô tả</label>
                    <textarea id="subjectDesc" placeholder="Nhập mô tả môn thi" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" rows="3"></textarea>
                </div>
                <div class="flex gap-3 justify-end">
                    <button type="button" class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg" onclick="closeSubjectModal()">Hủy</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4" id="questionModalTitle">Thêm câu hỏi</h3>
            <form id="questionForm" onsubmit="saveQuestion(event)">
                <input type="hidden" id="questionId"/>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Môn thi</label>
                    <select id="questionSubjectId" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Nội dung câu hỏi</label>
                    <textarea id="questionText" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" rows="3" required></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Đáp án A</label>
                        <input type="text" id="optionA" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Đáp án B</label>
                        <input type="text" id="optionB" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Đáp án C</label>
                        <input type="text" id="optionC" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Đáp án D</label>
                        <input type="text" id="optionD" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required/>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Đáp án đúng</label>
                    <select id="correctAnswer" class="w-full px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="flex gap-3 justify-end">
                    <button type="button" class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg" onclick="closeQuestionModal()">Hủy</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'Admin') {
            window.location.href = 'index.html';
        }
        document.getElementById('userName').textContent = user.fullName || user.username;

        let subjects = [];
        let questions = [];

        function showTab(tab) {
            ['subjects', 'questions', 'history'].forEach(t => {
                document.getElementById(t + 'Tab').classList.add('hidden');
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('text-primary', 'border-b-2', 'border-primary');
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('text-slate-500');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('text-primary', 'border-b-2', 'border-primary');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('text-slate-500');
            
            if (tab === 'subjects') loadSubjects();
            if (tab === 'questions') loadQuestions();
            if (tab === 'history') loadHistory();
        }

        async function loadSubjects() {
            try {
                const res = await adminAPI.getSubjects();
                subjects = await res.json();
                const tbody = document.getElementById('subjectTableBody');
                if (subjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Chưa có môn thi nào</td></tr>';
                    return;
                }
                tbody.innerHTML = subjects.map(s => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="px-6 py-4">${s.SubjectID}</td>
                        <td class="px-6 py-4 font-medium">${s.SubjectName}</td>
                        <td class="px-6 py-4 text-slate-500">${s.Description || '-'}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-primary hover:underline mr-3" onclick="editSubject(${s.SubjectID})">Sửa</button>
                            <button class="text-red-500 hover:underline" onclick="deleteSubject(${s.SubjectID})">Xóa</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update filter dropdowns
                const options = subjects.map(s => `<option value="${s.SubjectID}">${s.SubjectName}</option>`).join('');
                document.getElementById('filterSubject').innerHTML = '<option value="">Tất cả môn thi</option>' + options;
                document.getElementById('questionSubjectId').innerHTML = options;
            } catch (e) {
                console.error(e);
            }
        }

        async function loadQuestions() {
            try {
                const subjectId = document.getElementById('filterSubject').value;
                const res = await adminAPI.getQuestions(subjectId || undefined);
                questions = await res.json();
                const tbody = document.getElementById('questionTableBody');
                if (questions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">Chưa có câu hỏi nào</td></tr>';
                    return;
                }
                const subjectMap = {};
                subjects.forEach(s => subjectMap[s.SubjectID] = s.SubjectName);
                tbody.innerHTML = questions.map(q => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="px-6 py-4">${q.QuestionID}</td>
                        <td class="px-6 py-4 max-w-xs truncate">${q.QuestionText}</td>
                        <td class="px-6 py-4">${subjectMap[q.SubjectID] || '-'}</td>
                        <td class="px-6 py-4 font-bold text-green-600">${q.CorrectAnswer}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-primary hover:underline mr-3" onclick="editQuestion(${q.QuestionID})">Sửa</button>
                            <button class="text-red-500 hover:underline" onclick="deleteQuestion(${q.QuestionID})">Xóa</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function loadHistory() {
            try {
                const res = await adminAPI.getAllExamHistory();
                const history = await res.json();
                const tbody = document.getElementById('historyTableBody');
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">Chưa có lịch sử thi</td></tr>';
                    return;
                }
                tbody.innerHTML = history.map(h => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="px-6 py-4">${h.ExamID}</td>
                        <td class="px-6 py-4">${h.Username || 'User ' + h.UserID}</td>
                        <td class="px-6 py-4">${h.SubjectName}</td>
                        <td class="px-6 py-4 font-bold text-primary">${h.Score}/10</td>
                        <td class="px-6 py-4 text-slate-500">${new Date(h.ExamDate).toLocaleString('vi-VN')}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        function showSubjectModal(subject = null) {
            document.getElementById('subjectModal').classList.remove('hidden');
            document.getElementById('subjectModal').classList.add('flex');
            document.getElementById('subjectModalTitle').textContent = subject ? 'Sửa môn thi' : 'Thêm môn thi';
            document.getElementById('subjectId').value = subject?.SubjectID || '';
            document.getElementById('subjectName').value = subject?.SubjectName || '';
            document.getElementById('subjectDesc').value = subject?.Description || '';
        }

        function closeSubjectModal() {
            document.getElementById('subjectModal').classList.add('hidden');
            document.getElementById('subjectModal').classList.remove('flex');
        }

        async function saveSubject(e) {
            e.preventDefault();
            const id = document.getElementById('subjectId').value;
            const data = {
                subjectName: document.getElementById('subjectName').value,
                description: document.getElementById('subjectDesc').value
            };
            try {
                let res;
                if (id) {
                    res = await adminAPI.updateSubject(id, data);
                } else {
                    res = await adminAPI.createSubject(data);
                }
                if (res.ok) {
                    closeSubjectModal();
                    loadSubjects();
                } else {
                    alert('Lỗi lưu dữ liệu');
                }
            } catch (e) {
                alert('Lỗi kết nối');
            }
        }

        function editSubject(id) {
            const subject = subjects.find(s => s.SubjectID === id);
            showSubjectModal(subject);
        }

        async function deleteSubject(id) {
            if (!confirm('Bạn có chắc muốn xóa môn thi này?')) return;
            try {
                const res = await adminAPI.deleteSubject(id);
                if (res.ok) loadSubjects();
                else alert('Lỗi xóa dữ liệu');
            } catch (e) {
                alert('Lỗi kết nối');
            }
        }

        function showQuestionModal(question = null) {
            document.getElementById('questionModal').classList.remove('hidden');
            document.getElementById('questionModal').classList.add('flex');
            document.getElementById('questionModalTitle').textContent = question ? 'Sửa câu hỏi' : 'Thêm câu hỏi';
            document.getElementById('questionId').value = question?.QuestionID || '';
            document.getElementById('questionSubjectId').value = question?.SubjectID || subjects[0]?.SubjectID || '';
            document.getElementById('questionText').value = question?.QuestionText || '';
            document.getElementById('optionA').value = question?.OptionA || '';
            document.getElementById('optionB').value = question?.OptionB || '';
            document.getElementById('optionC').value = question?.OptionC || '';
            document.getElementById('optionD').value = question?.OptionD || '';
            document.getElementById('correctAnswer').value = question?.CorrectAnswer || 'A';
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.add('hidden');
            document.getElementById('questionModal').classList.remove('flex');
        }

        async function saveQuestion(e) {
            e.preventDefault();
            const id = document.getElementById('questionId').value;
            const data = {
                subjectId: document.getElementById('questionSubjectId').value,
                questionText: document.getElementById('questionText').value,
                optionA: document.getElementById('optionA').value,
                optionB: document.getElementById('optionB').value,
                optionC: document.getElementById('optionC').value,
                optionD: document.getElementById('optionD').value,
                correctAnswer: document.getElementById('correctAnswer').value
            };
            try {
                let res;
                if (id) {
                    res = await adminAPI.updateQuestion(id, data);
                } else {
                    res = await adminAPI.createQuestion(data);
                }
                if (res.ok) {
                    closeQuestionModal();
                    loadQuestions();
                } else {
                    alert('Lỗi lưu dữ liệu');
                }
            } catch (e) {
                alert('Lỗi kết nối');
            }
        }

        function editQuestion(id) {
            const question = questions.find(q => q.QuestionID === id);
            showQuestionModal(question);
        }

        async function deleteQuestion(id) {
            if (!confirm('Bạn có chắc muốn xóa câu hỏi này?')) return;
            try {
                const res = await adminAPI.deleteQuestion(id);
                if (res.ok) loadQuestions();
                else alert('Lỗi xóa dữ liệu');
            } catch (e) {
                alert('Lỗi kết nối');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        loadSubjects();
    </script>
</body>
</html>
