<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n l√Ω Thi Tr·∫Øc Nghi·ªám</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #343a40;
        }
        .sidebar a {
            color: #fff;
            padding: 15px 20px;
            display: block;
            text-decoration: none;
        }
        .sidebar a:hover, .sidebar a.active {
            background: #495057;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <h4 class="text-white p-3">Admin Panel</h4>
                <a href="#" onclick="showSection('subjects')" id="nav-subjects" class="active">üìö Qu·∫£n l√Ω M√¥n thi</a>
                <a href="#" onclick="showSection('questions')" id="nav-questions">‚ùì Qu·∫£n l√Ω C√¢u h·ªèi</a>
                <a href="#" onclick="showSection('history')" id="nav-history">üìä L·ªãch s·ª≠ thi</a>
                <a href="index.html" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</a>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <!-- Subjects Section -->
                <div id="subjects-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Qu·∫£n l√Ω M√¥n thi</h2>
                        <button class="btn btn-primary" onclick="showAddSubjectModal()">+ Th√™m M√¥n thi</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table class="table table-hover" id="subjectsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√™n m√¥n</th>
                                        <th>M√¥ t·∫£</th>
                                        <th>Ng√†y t·∫°o</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="subjectsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div id="questions-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Qu·∫£n l√Ω C√¢u h·ªèi</h2>
                        <div>
                            <select class="form-select d-inline-block w-auto me-2" id="filterSubject" onchange="loadQuestions()">
                                <option value="">T·∫•t c·∫£ m√¥n</option>
                            </select>
                            <button class="btn btn-primary" onclick="showAddQuestionModal()">+ Th√™m C√¢u h·ªèi</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table class="table table-hover" id="questionsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>M√¥n</th>
                                        <th>C√¢u h·ªèi</th>
                                        <th>ƒê√°p √°n ƒë√∫ng</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="questionsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div id="history-section" style="display: none;">
                    <h2 class="mb-4">L·ªãch s·ª≠ thi to√†n h·ªá th·ªëng</h2>
                    <div class="card">
                        <div class="card-body">
                            <table class="table table-hover" id="historyTable">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Ng∆∞·ªùi d√πng</th>
                                        <th>M√¥n thi</th>
                                        <th>ƒêi·ªÉm</th>
                                        <th>S·ªë c√¢u ƒë√∫ng</th>
                                        <th>Ng√†y thi</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div class="modal fade" id="subjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="subjectModalTitle">Th√™m M√¥n thi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="subjectForm">
                        <input type="hidden" id="subjectId">
                        <div class="mb-3">
                            <label class="form-label" for="subjectName">T√™n m√¥n thi</label>
                            <input type="text" class="form-control" id="subjectName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="subjectDescription">M√¥ t·∫£</label>
                            <textarea class="form-control" id="subjectDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveSubject()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
    <div class="modal fade" id="questionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionModalTitle">Th√™m C√¢u h·ªèi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="questionForm">
                        <input type="hidden" id="questionId">
                        <div class="mb-3">
                            <label class="form-label" for="questionSubject">M√¥n thi</label>
                            <select class="form-select" id="questionSubject" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="questionText">N·ªôi dung c√¢u h·ªèi</label>
                            <textarea class="form-control" id="questionText" rows="2" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="optionA">ƒê√°p √°n A</label>
                                <input type="text" class="form-control" id="optionA" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="optionB">ƒê√°p √°n B</label>
                                <input type="text" class="form-control" id="optionB" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="optionC">ƒê√°p √°n C</label>
                                <input type="text" class="form-control" id="optionC" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="optionD">ƒê√°p √°n D</label>
                                <input type="text" class="form-control" id="optionD" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="correctAnswer">ƒê√°p √°n ƒë√∫ng</label>
                            <select class="form-select" id="correctAnswer" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuestion()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let subjectModal, questionModal;

        // Check authentication
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'Admin') {
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            subjectModal = new bootstrap.Modal(document.getElementById('subjectModal'));
            questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
            loadSubjects();
            loadSubjectsForSelect();
        });

        function showSection(section) {
            document.getElementById('subjects-section').style.display = section === 'subjects' ? 'block' : 'none';
            document.getElementById('questions-section').style.display = section === 'questions' ? 'block' : 'none';
            document.getElementById('history-section').style.display = section === 'history' ? 'block' : 'none';

            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            document.getElementById(`nav-${section}`).classList.add('active');

            if (section === 'subjects') loadSubjects();
            if (section === 'questions') loadQuestions();
            if (section === 'history') loadAllHistory();
        }

        // ===== SUBJECTS =====
        async function loadSubjects() {
            try {
                const response = await adminAPI.getSubjects();
                const subjects = await response.json();

                const tbody = document.getElementById('subjectsBody');
                if (subjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ m√¥n thi n√†o</td></tr>';
                    return;
                }

                tbody.innerHTML = subjects.map(s => `
                    <tr>
                        <td>${s.SubjectID}</td>
                        <td>${s.SubjectName}</td>
                        <td>${s.Description || ''}</td>
                        <td>${new Date(s.CreatedAt).toLocaleDateString('vi-VN')}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editSubject(${s.SubjectID}, '${s.SubjectName}', '${s.Description || ''}')">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubject(${s.SubjectID})">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói t·∫£i danh s√°ch m√¥n thi');
            }
        }

        function showAddSubjectModal() {
            document.getElementById('subjectId').value = '';
            document.getElementById('subjectModalTitle').textContent = 'Th√™m M√¥n thi';
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectDescription').value = '';
            subjectModal.show();
        }

        function editSubject(id, name, description) {
            document.getElementById('subjectId').value = id;
            document.getElementById('subjectModalTitle').textContent = 'S·ª≠a M√¥n thi';
            document.getElementById('subjectName').value = name;
            document.getElementById('subjectDescription').value = description;
            subjectModal.show();
        }

        async function saveSubject() {
            const id = document.getElementById('subjectId').value;
            const data = {
                subjectName: document.getElementById('subjectName').value,
                description: document.getElementById('subjectDescription').value
            };

            try {
                let response;
                if (id) {
                    response = await adminAPI.updateSubject(id, data);
                } else {
                    response = await adminAPI.createSubject(data);
                }

                if (response.ok) {
                    subjectModal.hide();
                    loadSubjects();
                    loadSubjectsForSelect();
                } else {
                    const err = await response.json();
                    alert(err.error || 'L·ªói l∆∞u m√¥n thi');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        async function deleteSubject(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n thi n√†y?')) return;

            try {
                const response = await adminAPI.deleteSubject(id);
                if (response.ok) {
                    loadSubjects();
                    loadSubjectsForSelect();
                } else {
                    const err = await response.json();
                    alert(err.error || 'L·ªói x√≥a m√¥n thi');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        async function loadSubjectsForSelect() {
            try {
                const response = await adminAPI.getSubjects();
                const subjects = await response.json();

                const options = subjects.map(s => `<option value="${s.SubjectID}">${s.SubjectName}</option>`).join('');
                document.getElementById('questionSubject').innerHTML = options;
                document.getElementById('filterSubject').innerHTML = '<option value="">T·∫•t c·∫£ m√¥n</option>' + options;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ===== QUESTIONS =====
        async function loadQuestions() {
            const subjectId = document.getElementById('filterSubject').value;
            
            try {
                const response = await adminAPI.getQuestions(subjectId);
                const data = await response.json();
                
                // Get subjects for display
                const subjResponse = await adminAPI.getSubjects();
                const subjects = await subjResponse.json();
                const subjMap = {};
                subjects.forEach(s => subjMap[s.SubjectID] = s.SubjectName);

                const tbody = document.getElementById('questionsBody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ c√¢u h·ªèi n√†o</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(q => `
                    <tr>
                        <td>${q.QuestionID}</td>
                        <td>${subjMap[q.SubjectID] || 'N/A'}</td>
                        <td>${q.QuestionText.substring(0, 50)}...</td>
                        <td><span class="badge bg-success">${q.CorrectAnswer}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editQuestion(${q.QuestionID})">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.QuestionID})">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói t·∫£i danh s√°ch c√¢u h·ªèi');
            }
        }

        function showAddQuestionModal() {
            document.getElementById('questionId').value = '';
            document.getElementById('questionModalTitle').textContent = 'Th√™m C√¢u h·ªèi';
            document.getElementById('questionForm').reset();
            questionModal.show();
        }

        async function editQuestion(id) {
            try {
                const response = await adminAPI.getQuestion(id);
                const q = await response.json();

                document.getElementById('questionId').value = q.QuestionID;
                document.getElementById('questionModalTitle').textContent = 'S·ª≠a C√¢u h·ªèi';
                document.getElementById('questionSubject').value = q.SubjectID;
                document.getElementById('questionText').value = q.QuestionText;
                document.getElementById('optionA').value = q.OptionA;
                document.getElementById('optionB').value = q.OptionB;
                document.getElementById('optionC').value = q.OptionC;
                document.getElementById('optionD').value = q.OptionD;
                document.getElementById('correctAnswer').value = q.CorrectAnswer;
                
                questionModal.show();
            } catch (error) {
                alert('L·ªói t·∫£i th√¥ng tin c√¢u h·ªèi');
            }
        }

        async function saveQuestion() {
            const id = document.getElementById('questionId').value;
            const data = {
                subjectId: parseInt(document.getElementById('questionSubject').value),
                questionText: document.getElementById('questionText').value,
                optionA: document.getElementById('optionA').value,
                optionB: document.getElementById('optionB').value,
                optionC: document.getElementById('optionC').value,
                optionD: document.getElementById('optionD').value,
                correctAnswer: document.getElementById('correctAnswer').value
            };

            try {
                let response;
                if (id) {
                    response = await adminAPI.updateQuestion(id, data);
                } else {
                    response = await adminAPI.createQuestion(data);
                }

                if (response.ok) {
                    questionModal.hide();
                    loadQuestions();
                } else {
                    const err = await response.json();
                    alert(err.error || 'L·ªói l∆∞u c√¢u h·ªèi');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?')) return;

            try {
                const response = await adminAPI.deleteQuestion(id);
                if (response.ok) {
                    loadQuestions();
                } else {
                    const err = await response.json();
                    alert(err.error || 'L·ªói x√≥a c√¢u h·ªèi');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        // ===== HISTORY =====
        async function loadAllHistory() {
            try {
                const response = await adminAPI.getAllExamHistory();
                const history = await response.json();

                const tbody = document.getElementById('historyBody');
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ l·ªãch s·ª≠ thi n√†o</td></tr>';
                    return;
                }

                tbody.innerHTML = history.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.FullName || item.Username}</td>
                        <td>${item.SubjectName}</td>
                        <td><span class="badge ${item.Score >= 5 ? 'bg-success' : 'bg-danger'}">${item.Score}</span></td>
                        <td>${item.CorrectAnswers}/${item.TotalQuestions}</td>
                        <td>${new Date(item.ExamDate).toLocaleString('vi-VN')}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói t·∫£i l·ªãch s·ª≠ thi');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
